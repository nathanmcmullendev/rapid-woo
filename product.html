<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Product ‚Ä¢ RapidWoo</title>

  <!-- Styles (relative) -->
  <link rel="stylesheet" href="assets/css/main.css" />
  <link rel="stylesheet" href="assets/css/components.css" />

  <!-- Snipcart (v3.4.1) -->
  <script src="https://cdn.snipcart.com/themes/v3.4.1/default/snipcart.js"></script>
  <link rel="stylesheet" href="https://cdn.snipcart.com/themes/v3.4.1/default/snipcart.css" />

  <!-- Core scripts (data + utils only) -->
  <script src="assets/js/config.js"></script>
  <script src="assets/js/storage.js"></script>
  <script src="assets/js/utils.js"></script>

  <style>
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    .crumbs { display:flex; gap:12px; align-items:center; color:#6b7280; font-size:14px; }
    .crumbs a { color:#6b7280; text-decoration:none; }
    .header-nav { border-bottom:1px solid #e5e7eb; background:#fff; }
    .header-inner { max-width:1200px; margin:0 auto; padding:14px 24px; display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .nav-left, .nav-right { display:flex; align-items:center; gap:14px; }

    .layout { display:grid; grid-template-columns: 1.05fr 1fr; gap:28px; margin-top:16px; }
    @media (max-width: 980px) { .layout { grid-template-columns: 1fr; } }

    .gallery { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; }
    .hero { position:relative; width:100%; aspect-ratio: 4 / 3; background:#fafafa; border-radius:12px; overflow:hidden; display:grid; place-items:center; }
    .hero img { position:absolute; inset:0; width:100%; height:100%; object-fit:contain; object-position:center; display:block; }
    .thumbs { display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; margin-top:10px; }
    .thumbs img { width:100%; aspect-ratio:1/1; object-fit:cover; border-radius:8px; border:1px solid #eee; cursor:pointer; }
    .thumbs img.active { outline:2px solid #2271b1; }

    .panel { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:16px; }
    .title { font-size:26px; font-weight:800; margin:0 0 8px; }
    .cats { color:#6b7280; font-size:13px; margin-bottom:10px; }
    .meta-bar { display:flex; align-items:center; gap:12px; margin:8px 0 12px; }
    .price { font-size:22px; font-weight:800; display:flex; gap:10px; align-items:center; }
    .price del { color:#6b7280; font-weight:400; }
    .stock-badge { font-size:13px; }
    .stock-badge.instock { color:#008a20; }
    .stock-badge.outofstock { color:#d63638; }
    .badge-featured { display:inline-flex; gap:6px; align-items:center; background:#f6f7f7; border:1px solid #e5e7eb; border-radius:999px; padding:4px 10px; font-size:12px; }

    .buy-row { display:flex; align-items:center; gap:10px; margin: 8px 0 18px; }
    .buy-row .qty { display:flex; align-items:center; gap:6px; }
    .buy-row input[type="number"] { width:100px; padding:10px 12px; border:1px solid #dcdfe6; border-radius:10px; }
    .add-slot { display:flex; gap:10px; align-items:center; }

    .desc-panel { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:16px; margin-top:16px; }
    .desc-panel h3 { margin:0 0 8px; font-size:16px; font-weight:700; }
    .desc { color:#374151; line-height:1.6; }
    .empty, .loading { background:#f6f7f7; border:1px solid #e5e7eb; border-radius:12px; padding:28px; text-align:center; margin-top:16px; }
  </style>
</head>
<body>

  <!-- Snipcart configuration -->
  <div hidden id="snipcart"
       data-api-key="YTNhNTA0OWQtMjQ4NS00MTg0LWI0NjYtNTdiNTM5NmYxOTE1NjM4ODgyMjg4ODE0ODkwMzUw"
       data-config-add-product-behavior="none"
       data-config-modal-style="side"
       data-currency="usd">
  </div>
  <script>
    window.SnipcartSettings = {
      publicApiKey: "YTNhNTA0OWQtMjQ4NS00MTg0LWI0NjYtNTdiNTM5NmYxOTE1NjM4ODgyMjg4ODE0ODkwMzUw",
      loadStrategy: "on-user-interaction",
      currency: "usd"
    };
  </script>

  <!-- Header -->
  <header class="header-nav">
    <div class="header-inner">
      <div class="nav-left">
        <a href="index.html" class="muted-link" style="text-decoration:none;">Home</a>
        <a href="shop.html" class="muted-link" style="text-decoration:none;">Shop</a>
        <a href="demo/index.html" class="muted-link" style="text-decoration:none;">Editor</a>
        <strong>Product</strong>
      </div>
      <div class="nav-right">
        <button class="snipcart-checkout button">
          üõí Cart (<span class="snipcart-items-count">0</span>)
        </button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="crumbs">
      <a href="index.html">Home</a> <span>‚Ä∫</span>
      <a href="shop.html">Shop</a> <span>‚Ä∫</span>
      <span id="crumb-title">Product</span>
    </div>

    <section id="loading" class="loading">
      <h2 style="font-size:18px; margin-bottom:6px;">Loading product...</h2>
      <p class="muted">Please wait.</p>
    </section>

    <section id="not-found" class="empty" style="display:none;">
      <h2 style="font-size:18px; margin-bottom:6px;">Product not found</h2>
      <p class="muted">The product you're looking for doesn't exist or is unavailable.</p>
      <div style="margin-top:14px;">
        <a href="shop.html" class="button button-primary">Back to shop</a>
      </div>
    </section>

    <section id="product-layout" class="layout" style="display:none;">
      <div>
        <div class="gallery">
          <div class="hero" id="hero">
            <div style="font-size:64px;color:#ccc;">üì¶</div>
          </div>
          <div class="thumbs" id="thumbs" style="display:none;"></div>
        </div>

        <div class="desc-panel">
          <h3>Description</h3>
          <div id="description" class="desc"></div>
        </div>
      </div>

      <aside class="panel">
        <div class="cats" id="cats"></div>
        <h1 class="title" id="title">Product</h1>

        <div class="meta-bar">
          <div class="price" id="price">$0.00</div>
          <span class="stock-badge" id="stock">In Stock</span>
          <span class="badge-featured" id="featured" style="display:none;">‚≠ê Featured</span>
        </div>

        <div id="variations-wrap" class="desc-panel" style="margin: 6px 0 14px; display:none;">
          <h3 style="margin:0 0 8px;">Choose Options</h3>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <label for="attr-Size" style="font-weight:600;">Size</label>
            <select id="attr-Size" class="fpe-select" style="min-width: 140px;"></select>
            <span id="variation-sku" class="small" style="opacity:.8;"></span>
          </div>
        </div>

        <div class="buy-row">
          <div class="qty">
            <label for="product-qty" style="font-weight:600">Qty</label>
            <input id="product-qty" type="number" min="1" step="1" value="1" />
          </div>
          <div class="add-slot" id="add-slot"></div>
        </div>

        <div class="desc-panel" style="margin-top:0;">
          <h3>At a glance</h3>
          <div class="desc" id="excerpt"></div>
        </div>
      </aside>
    </section>
  </main>

  <div id="validation-product" style="display:none;"></div>

<script>
(function () {
  const nf = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

  const Utils = window.RapidWoo?.Utils || {
    q: (s, r=document) => r.querySelector(s),
    qa: (s, r=document) => Array.from(r.querySelectorAll(s)),
  };
  const Storage = window.RapidWoo?.Storage;

  const isHttpUrl = (u) => typeof u === 'string' && /^https?:\/\//i.test(u);

  function textOf(htmlish) {
    if (!htmlish) return '';
    const div = document.createElement('div');
    div.innerHTML = htmlish;
    return (div.textContent || div.innerText || '').trim();
  }

  function priceOf(p) {
    const candidates = [p?.sale_price, p?.price, p?.regular_price];
    for (const v of candidates) {
      if (v === null || v === undefined) continue;
      const s = String(v).trim();
      if (!s) continue;
      const n = Number(s);
      if (Number.isFinite(n) && n > 0) return n;
    }
    return null;
  }

  // URL for navigation
  function productUrl(p) {
    const slugOrId = p.slug || p.id;
    return `product.html?product=${encodeURIComponent(slugOrId)}`;
  }

  // URL for Snipcart validation (JSON endpoint) - works on both rapidwoo.com and GitHub Pages
  function snipcartValidationUrl() {
    if (window.location.hostname.includes('github.io')) {
      return '/rapid-woo/snipcart-products.json';
    }
    return '/snipcart-products.json';
  }

  function productImages(p) {
    const out = [];
    const primary = p?.image || '';
    if (primary) out.push(primary);
    if (Array.isArray(p?.images)) {
      p.images.forEach(x => {
        const src = x?.src || x;
        if (src && src !== primary) out.push(src);
      });
    }
    return out;
  }

  function getParam(name) {
    const u = new URL(window.location.href);
    return u.searchParams.get(name);
  }

  function isVariable(prod){ return prod?.type === 'variable' && Array.isArray(prod?.variations) && prod.variations.length > 0; }
  function getSizes(prod){ return (prod?.attributes && prod.attributes.Size) || []; }
  function getVariationBySize(prod, size){ return (prod?.variations || []).find(v => v.attributes?.Size === size) || null; }
  function deltaNum(delta){ if (!delta) return 0; const n = Number(String(delta).replace(/[+]/g,'').trim()); return Number.isFinite(n) ? n : 0; }

  function buildSnipcartButton(p) {
    const addSlot = Utils.q('#add-slot');
    addSlot.innerHTML = '';

    const btn = document.createElement('button');
    btn.className = 'button button-primary snipcart-add-item';
    btn.textContent = 'üõí Add to Cart';

    const idAttr = String(p.id || p.slug || Math.random()).replace(/\s+/g,'-');
    const titleAttr = p.title || 'Product';
    const img = productImages(p)[0] || '';
    const desc = textOf(p.short_description || p.description || '');
    const basePrice = priceOf(p);
    const validBase = Number.isFinite(basePrice) && basePrice > 0;

    btn.setAttribute('data-item-id', idAttr);
    btn.setAttribute('data-item-name', titleAttr);
    btn.setAttribute('data-item-price', validBase ? String(basePrice.toFixed(2)) : '0');
    btn.setAttribute('data-item-url', snipcartValidationUrl());
    if (img && isHttpUrl(img)) btn.setAttribute('data-item-image', img);
    if (desc) btn.setAttribute('data-item-description', desc);

    const qtyInput = Utils.q('#product-qty');

    if (isVariable(p)) {
      const wrap = Utils.q('#variations-wrap');
      const sel = Utils.q('#attr-Size');
      const skuEl = Utils.q('#variation-sku');
      wrap.style.display = '';

      const sizes = getSizes(p);
      sel.innerHTML = sizes.map(s => `<option value="${s}">${s}</option>`).join('');

      const optionsStr = sizes.map(s => {
        const v = getVariationBySize(p, s) || {};
        const vr = Number(v.sale_price || v.regular_price);
        const hasVr = Number.isFinite(vr) && vr > 0;
        const delta = hasVr ? (vr - basePrice) : deltaNum(v.price_delta || '+0.00');
        return delta ? `${s}[${delta >= 0 ? '+' : ''}${delta.toFixed(2)}]` : s;
      }).join('|');

      btn.setAttribute('data-item-custom1-name', 'Size');
      btn.setAttribute('data-item-custom1-options', optionsStr);
      btn.setAttribute('data-item-custom1-required', 'true');

      const priceEl = Utils.q('#price');
      function apply(size){
        const v = getVariationBySize(p, size);
        skuEl.textContent = v?.sku ? `SKU: ${v.sku}` : '';

        const varReg = Number(v?.regular_price);
        const varSale = Number(v?.sale_price);
        const hasVarReg = Number.isFinite(varReg) && varReg > 0;
        const hasVarSale = Number.isFinite(varSale) && varSale > 0;

        if (hasVarSale || hasVarReg) {
          priceEl.innerHTML = (hasVarSale && hasVarReg && varSale !== varReg)
            ? `<del>${nf.format(varReg)}</del> <span>${nf.format(varSale)}</span>`
            : `<span>${nf.format(hasVarSale ? varSale : varReg)}</span>`;
        } else {
          const delta = deltaNum(v?.price_delta || '+0.00');
          const reg = Number(String(p.regular_price ?? p.price ?? '').trim());
          const sale = Number(String(p.sale_price ?? '').trim());
          const hasSale = Number.isFinite(sale) && sale > 0 && Number.isFinite(reg) && reg > 0 && sale !== reg;

          const effective = (Number.isFinite(basePrice) ? basePrice : 0) + delta;
          priceEl.innerHTML = hasSale
            ? `<del>${nf.format(reg + delta)}</del> <span>${nf.format(sale + delta)}</span>`
            : `<span>${nf.format(effective)}</span>`;
        }
      }

      const initial = sizes[0];
      sel.value = initial; apply(initial);
      sel.addEventListener('change', () => apply(sel.value));

      btn.addEventListener('click', () => {
        const qty = Math.max(1, Number(qtyInput?.value || 1));
        btn.setAttribute('data-item-quantity', String(qty));

        const size = sel.value || initial;
        btn.setAttribute('data-item-custom1-value', size);

        const v = getVariationBySize(p, size);
        if (v?.sku) {
          btn.setAttribute('data-item-metadata', JSON.stringify({ variant_sku: v.sku }));
        }

        const stock = p.stock_status || 'instock';
        if (stock === 'instock' && validBase) btn.removeAttribute('disabled');
      });
    } else {
      const wrap = Utils.q('#variations-wrap');
      if (wrap) wrap.style.display = 'none';

      btn.addEventListener('click', () => {
        const qty = Math.max(1, Number(qtyInput?.value || 1));
        btn.setAttribute('data-item-quantity', String(qty));
        const stock = p.stock_status || 'instock';
        if (stock === 'instock' && validBase) btn.removeAttribute('disabled');
      });
    }

    const stock = p.stock_status || 'instock';
    if (stock !== 'instock' || !validBase) btn.setAttribute('disabled', '');

    addSlot.appendChild(btn);

    // Hidden validation product
    const vp = Utils.q('#validation-product');
    vp.innerHTML = '';
    const v = document.createElement('div');
    v.className = 'snipcart-add-item';
    v.setAttribute('data-item-id', idAttr);
    v.setAttribute('data-item-name', titleAttr);
    v.setAttribute('data-item-price', validBase ? String(basePrice.toFixed(2)) : '0');
    v.setAttribute('data-item-url', snipcartValidationUrl());
    if (img && isHttpUrl(img)) v.setAttribute('data-item-image', img);
    if (desc) v.setAttribute('data-item-description', desc);

    if (isVariable(p)) {
      const sizes = getSizes(p);
      const optionsStr = sizes.map(s => {
        const vv = getVariationBySize(p, s) || {};
        const vr = Number(vv.sale_price || vv.regular_price);
        const hasVr = Number.isFinite(vr) && vr > 0;
        const delta = hasVr ? (vr - basePrice) : deltaNum(vv.price_delta || '+0.00');
        return delta ? `${s}[${delta >= 0 ? '+' : ''}${delta.toFixed(2)}]` : s;
      }).join('|');

      v.setAttribute('data-item-custom1-name', 'Size');
      v.setAttribute('data-item-custom1-options', optionsStr);
      v.setAttribute('data-item-custom1-value', sizes[0] || '');
    }

    vp.appendChild(v);
  }

  function renderGallery(p) {
    const hero = Utils.q('#hero');
    const thumbs = Utils.q('#thumbs');
    const images = productImages(p);

    hero.innerHTML = images.length
      ? `<img src="${images[0]}" alt="${(p.title || 'Product').replace(/"/g,'&quot;')}" />`
      : `<div style="font-size:64px;color:#ccc;">üì¶</div>`;

    thumbs.innerHTML = '';
    if (images.length > 1) {
      thumbs.style.display = '';
      images.forEach((src, idx) => {
        const t = document.createElement('img');
        t.src = src;
        if (idx === 0) t.classList.add('active');
        t.addEventListener('click', () => {
          hero.innerHTML = `<img src="${src}" alt="${(p.title || 'Product').replace(/"/g,'&quot;')}" />`;
          Utils.qa('#thumbs img').forEach(n => n.classList.remove('active'));
          t.classList.add('active');
        });
        thumbs.appendChild(t);
      });
    } else {
      thumbs.style.display = 'none';
    }
  }

  function renderProduct(p) {
    Utils.q('#title').textContent = p.title || 'Product';
    Utils.q('#crumb-title').textContent = p.title || 'Product';
    document.title = `${p.title || 'Product'} ‚Ä¢ RapidWoo`;

    const cats = (p.categories && p.categories.length) ? p.categories.join(', ') : '';
    Utils.q('#cats').textContent = cats;

    const reg = Number(String(p.regular_price ?? p.price ?? '').trim());
    const saleNum = Number(String(p.sale_price ?? '').trim());
    const saleValid = Number.isFinite(saleNum) && saleNum > 0;
    const hasSale = saleValid && Number.isFinite(reg) && reg > 0 && saleNum !== reg;
    const effective = priceOf(p);

    Utils.q('#price').innerHTML = hasSale
      ? `<del>${nf.format(reg)}</del> <span>${nf.format(saleNum)}</span>`
      : `<span>${nf.format(effective ?? 0)}</span>`;

    const stock = p.stock_status || 'instock';
    const stockEl = Utils.q('#stock');
    stockEl.className = 'stock-badge ' + stock;
    stockEl.textContent = (stock === 'instock') ? 'In Stock' : (stock === 'outofstock') ? 'Out of Stock' : 'On Backorder';

    Utils.q('#featured').style.display = p.featured ? '' : 'none';

    const excerpt = textOf(p.short_description || '').trim();
    const desc = (p.description || '').trim();
    Utils.q('#excerpt').textContent = excerpt || '‚Äî';
    Utils.q('#description').innerHTML = desc || '<span class="muted">No description provided.</span>';

    renderGallery(p);
    buildSnipcartButton(p);
  }

  async function loadProducts() {
    try {
      if (!Storage?.getProducts) return [];
      const data = await Storage.getProducts();
      return (data?.products || []).filter(p => !p.hidden);
    } catch (e) {
      console.error('‚ùå Error loading products:', e);
      return [];
    }
  }

  function findProduct(idOrSlug, products) {
    if (!idOrSlug) return null;
    const key = String(idOrSlug).trim();
    let p = products.find(x => String(x.id) === key);
    if (!p) p = products.find(x => String(x.slug) === key);
    return p || null;
  }

  function show(state) {
    Utils.q('#loading').style.display = (state === 'loading') ? '' : 'none';
    Utils.q('#not-found').style.display = (state === 'not-found') ? '' : 'none';
    Utils.q('#product-layout').style.display = (state === 'ok') ? '' : 'none';
  }

  let productKey = null;
  async function init() {
    show('loading');
    productKey = getParam('product');
    if (!productKey) { show('not-found'); return; }

    const products = await loadProducts();
    const p = findProduct(productKey, products);
    if (!p) { show('not-found'); return; }

    renderProduct(p);
    show('ok');
  }

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
  else init();

  window.addEventListener('rapidwoo:products:updated', async () => {
    if (!productKey) return;
    const products = await loadProducts();
    const p = findProduct(productKey, products);
    if (p) { renderProduct(p); show('ok'); }
  });
})();
</script>

</body>
</html>
